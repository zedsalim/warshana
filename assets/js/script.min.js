const TOTAL_PAGES=604,SURAH_NO_BASMALA=9,state={quranData:[],audioUrlsSources:[],localAudioCache:{},useLocalAudio:!0,currentPage:1,currentSura:1,currentJuz:1,currentAyah:null,selectedReciter:"",audioPlayer:null,playQueue:[],currentPlayIndex:0,repeatCount:1,currentRepeatCount:0,currentPlayModeRepeatCount:0,isPlaying:!1};function getEl(t){return document.getElementById(t)}function saveSetting(t,e){localStorage.setItem(t,e)}function applyFontSize(t){getEl("quran-text").style.fontSize=t+"px"}function getAyahsOnPage(t){return state.quranData.filter(e=>e.page.split("-").some(e=>parseInt(e.trim())===t))}function setActiveAyahElement(t){document.querySelectorAll(".ayah.active").forEach(t=>t.classList.remove("active")),t&&(t.classList.add("active"),t.scrollIntoView({behavior:"smooth",block:"center"}))}function activateAyahInDOM(t,e){const a=document.querySelector(`[data-sura="${t}"][data-ayah="${e}"]`);return setActiveAyahElement(a),a}function buildAudioPath(t,e,a){return`assets/audio/${t}/${String(e).padStart(3,"0")}/${String(a).padStart(3,"0")}.mp3`}function getFallbackAudioUrl(t,e,a){const n=state.audioUrlsSources;if(!n||0===n.length)return null;const r=String(e).padStart(3,"0"),s=String(a).padStart(3,"0"),o=[...n.keys()].sort(()=>Math.random()-.5);for(const e of o){const a=n[e],o=a?.reciters;if(!o)continue;const u=o[t];if(!u)continue;const l=u[r];if(!l)continue;const c=l.find(t=>t.ayah===s);if(c?.url)return c.url}return null}async function checkLocalAudioAvailable(t,e){const a=`${t}/${e}`;if(a in state.localAudioCache)return state.localAudioCache[a];const n=buildAudioPath(t,e,1);try{const t=await fetch(n,{method:"HEAD"}),e=t.headers.get("Content-Type")||"",r=t.ok&&e.includes("audio");state.localAudioCache[a]=r}catch{state.localAudioCache[a]=!1}return state.localAudioCache[a]}function showToast(t){let e=document.getElementById("toast-container");e||(e=document.createElement("div"),e.id="toast-container",e.style.cssText="position:fixed;top:24px;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;",document.body.appendChild(e));const a=document.createElement("div");a.textContent=t,a.style.cssText="background:#5d4037;color:#fff;padding:12px 24px;border-radius:8px;font-family:Amiri,Arial,sans-serif;font-size:16px;box-shadow:0 4px 12px rgba(0,0,0,0.25);opacity:0;transition:opacity 0.3s;",e.appendChild(a),requestAnimationFrame(()=>{requestAnimationFrame(()=>{a.style.opacity="1"})}),setTimeout(()=>{a.style.opacity="0",setTimeout(()=>a.remove(),350)},3e3)}function restoreSavedAyah(t,e){const a=state.quranData.find(a=>a.sura_no===t&&a.aya_no===e);a&&(state.currentAyah=a,state.currentSura=t,getEl("surah-select").value=t,populateAyahSelector(t),getEl("ayah-select").value=e,updatePageInfo(a),activateAyahInDOM(t,e),updateNavButtonStates())}function loadSettings(){const t=localStorage.getItem("reciter")||"abdelbasset_abdessamad";getEl("reciter-select").value=t;const e=localStorage.getItem("speed")||"1";getEl("speed-control").value=e;const a=localStorage.getItem("repeat")||"1";getEl("repeat-control").value=a;const n=localStorage.getItem("playMode")||"sura";getEl("play-mode").value=n;const r=localStorage.getItem("fontSize")||"28";getEl("font-size-control").value=r,applyFontSize(r)}async function loadQuranData(){try{const t=await fetch("assets/text/UthmanicWarsh/warshData_v2-1.json");state.quranData=await t.json()}catch(t){console.error("Error loading Quran data:",t),showToast("خطأ في تحميل بيانات القرآن الكريم")}}async function loadAudioUrlsData(){const t=await Promise.allSettled(["assets/text/quran_audio_urls-1.json","assets/text/quran_audio_urls-2.json","assets/text/quran_audio_urls-3.json","assets/text/quran_audio_urls-4.json"].map(t=>fetch(t).then(t=>t.json())));state.audioUrlsSources=t.filter(t=>"fulfilled"===t.status).map(t=>t.value),0===state.audioUrlsSources.length?console.warn("Could not load any audio URLs fallback data."):console.log(`Loaded ${state.audioUrlsSources.length} audio URL source(s) for load balancing.`)}function initializeSelectors(){populateSurahSelector(),populateJuzSelector(),populatePageSelector()}function populateSurahSelector(){const t=getEl("surah-select");[...new Map(state.quranData.map(t=>[t.sura_no,t])).values()].forEach(e=>{const a=document.createElement("option");a.value=e.sura_no,a.textContent=`${e.sura_no}. ${e.sura_name_ar}`,t.appendChild(a)});const e=localStorage.getItem("currentSura")||"1";t.value=e,state.currentSura=parseInt(e)}function populateJuzSelector(){const t=getEl("juz-select");for(let e=1;e<=30;e++){const a=document.createElement("option");a.value=e,a.textContent=`الجزء ${e}`,t.appendChild(a)}const e=localStorage.getItem("currentJuz")||"1";t.value=e}function populatePageSelector(){const t=getEl("page-select");for(let e=1;e<=604;e++){const a=document.createElement("option");a.value=e,a.textContent=`صفحة ${e}`,t.appendChild(a)}const e=localStorage.getItem("currentPage")||"1";t.value=e}function populateAyahSelector(t){const e=getEl("ayah-select");e.innerHTML='<option value="">اختر الآية</option>',state.quranData.filter(e=>e.sura_no==t).forEach(t=>{const a=document.createElement("option");a.value=t.aya_no,a.textContent=`آية ${t.aya_no}`,e.appendChild(a)})}function updateSidebarSelectors(){state.currentAyah&&(getEl("surah-select").value=state.currentAyah.sura_no,getEl("ayah-select").value=state.currentAyah.aya_no)}function displayPage(t,e=!1){state.currentPage=t,saveSetting("currentPage",t);const a=getAyahsOnPage(t);if(0===a.length)return;const n=getEl("quran-text");n.innerHTML="";const r=new Set;let s=null;const o=new Set(a.filter(t=>1===t.aya_no).map(t=>t.sura_no));a.forEach((t,e)=>{if(t.sura_no!==s&&(s=t.sura_no,!r.has(t.sura_no))){r.add(t.sura_no);const e=document.createElement("div");if(e.className="sura-header",e.textContent=t.sura_name_ar,n.appendChild(e),o.has(t.sura_no)&&9!==t.sura_no){const t=document.createElement("div");t.className="basmala",t.textContent="بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ",n.appendChild(t)}}const a=document.createElement("span");a.className="ayah",a.dataset.sura=t.sura_no,a.dataset.ayah=t.aya_no,a.dataset.id=t.id,a.textContent=t.aya_text+" ",a.addEventListener("click",e=>handleAyahClickWithToggle(e,t)),n.appendChild(a)});updatePageInfo(a.find(t=>t.sura_no===state.currentSura)||a[0]),getEl("page-select").value=t,e||(state.currentSura=a[0].sura_no,getEl("surah-select").value=state.currentSura,saveSetting("currentSura",state.currentSura)),state.currentJuz=a[0].jozz,getEl("juz-select").value=state.currentJuz,saveSetting("currentJuz",state.currentJuz),populateAyahSelector(state.currentSura),getEl("prev-page").disabled=1===state.currentPage,getEl("next-page").disabled=604===state.currentPage}function updatePageInfo(t){getEl("sura-title").textContent=t.sura_name_ar,getEl("page-info").textContent=`الجزء ${t.jozz} - صفحة ${state.currentPage}`}function setCurrentAyah(t,{play:e=!1}={}){state.currentAyah=t,state.currentSura=t.sura_no,getEl("surah-select").value=t.sura_no,getEl("ayah-select").value=t.aya_no,updatePageInfo(t),saveSetting("currentSura",t.sura_no),saveSetting("currentAyah",t.aya_no),activateAyahInDOM(t.sura_no,t.aya_no),updateNavButtonStates(),e&&playAudio()}function selectAndPlayAyah(t){state.isPlaying&&stopAudio(),setCurrentAyah(t,{play:!0})}function handleAyahClickWithToggle(t,e){state.currentAyah&&state.currentAyah.sura_no===e.sura_no&&state.currentAyah.aya_no===e.aya_no?togglePauseResume():(state.currentAyah=e,state.currentSura=e.sura_no,getEl("surah-select").value=e.sura_no,getEl("ayah-select").value=e.aya_no,updatePageInfo(e),saveSetting("currentSura",e.sura_no),saveSetting("currentAyah",e.aya_no),activateAyahInDOM(e.sura_no,e.aya_no),updateNavButtonStates(),state.audioPlayer&&(state.audioPlayer.pause(),state.audioPlayer.src=""),state.isPlaying=!1,state.currentRepeatCount=0,state.currentPlayModeRepeatCount=0,setTimeout(()=>playAudio(),100))}function selectFirstAyahOfSurah(t){const e=state.quranData.find(e=>e.sura_no===t&&1===e.aya_no);e&&(state.currentAyah=e,state.currentSura=t,getEl("ayah-select").value=1,updatePageInfo(e),saveSetting("currentAyah",1),setTimeout(()=>activateAyahInDOM(t,1),100))}function initializeAudioPlayer(){state.audioPlayer=getEl("audio-player"),state.audioPlayer&&(state.audioPlayer.addEventListener("ended",()=>{state.currentRepeatCount++;const t=getEl("repeat-control").value,e="infinite"===t?1/0:parseInt(t);state.currentRepeatCount<e?state.audioPlayer.play():(state.currentRepeatCount=0,state.currentPlayIndex++,state.currentPlayIndex<state.playQueue.length?playNextInQueue():(state.currentPlayModeRepeatCount++,state.currentPlayModeRepeatCount<e?(state.currentPlayIndex=0,state.currentRepeatCount=0,rebuildFullPlayQueue(),playNextInQueue()):(state.currentPlayModeRepeatCount=0,stopAudio())))}),state.audioPlayer.addEventListener("play",()=>{state.isPlaying=!0,highlightActiveAyah(),updatePauseButton()}),state.audioPlayer.addEventListener("pause",()=>{state.isPlaying=!1,updatePauseButton()}))}async function playAudio(){if(state.selectedReciter=getEl("reciter-select").value,!state.selectedReciter)return void showToast("الرجاء اختيار القارئ");if(!state.currentAyah)return void showToast("الرجاء اختيار آية");const t=await checkLocalAudioAvailable(state.selectedReciter,state.currentAyah.sura_no);state.useLocalAudio=t,buildPlayQueue(),0!==state.playQueue.length?(state.currentPlayIndex=0,state.currentRepeatCount=0,state.currentPlayModeRepeatCount=0,playNextInQueue()):showToast("لا توجد ملفات صوتية للتشغيل")}function buildPlayQueue(){state.playQueue=[];const t=t=>{const e=state.currentAyah?t.findIndex(t=>t.id===state.currentAyah.id):0;return e>=0?t.slice(e):t};switch(getEl("play-mode").value){case"aya":state.currentAyah&&state.playQueue.push(state.currentAyah);break;case"page":state.playQueue=t(getAyahsOnPage(state.currentPage));break;case"sura":state.playQueue=t(state.quranData.filter(t=>t.sura_no===state.currentSura));break;case"juz":state.playQueue=t(state.quranData.filter(t=>t.jozz===state.currentJuz))}}function rebuildFullPlayQueue(){state.playQueue=[];switch(getEl("play-mode").value){case"aya":state.currentAyah&&state.playQueue.push(state.currentAyah);break;case"page":state.playQueue=getAyahsOnPage(state.currentPage);break;case"sura":state.playQueue=state.quranData.filter(t=>t.sura_no===state.currentSura);break;case"juz":state.playQueue=state.quranData.filter(t=>t.jozz===state.currentJuz)}}function playNextInQueue(){if(state.currentPlayIndex>=state.playQueue.length)return void stopAudio();const t=state.playQueue[state.currentPlayIndex];state.selectedReciter=getEl("reciter-select")?.value||"";const e=`${state.selectedReciter}/${t.sura_no}`;let a;e in state.localAudioCache?state.useLocalAudio=state.localAudioCache[e]:checkLocalAudioAvailable(state.selectedReciter,t.sura_no).then(t=>{state.useLocalAudio=t}),a=state.useLocalAudio?buildAudioPath(state.selectedReciter,t.sura_no,t.aya_no):getFallbackAudioUrl(state.selectedReciter,t.sura_no,t.aya_no)||buildAudioPath(state.selectedReciter,t.sura_no,t.aya_no),state.audioPlayer&&(state.audioPlayer.src=a,state.audioPlayer.playbackRate=parseFloat(getEl("speed-control")?.value||"1"),state.audioPlayer.play().catch(t=>{console.error("Error playing audio:",t),state.currentRepeatCount=0,state.currentPlayIndex++,state.currentPlayIndex<state.playQueue.length&&playNextInQueue()})),state.currentAyah=t,state.currentSura=t.sura_no,saveSetting("currentAyah",t.aya_no),saveSetting("currentSura",t.sura_no),updateSidebarSelectors(),updatePageInfo(t),highlightActiveAyah(),updateNavButtonStates();const n=document.querySelector(`[data-sura="${t.sura_no}"][data-ayah="${t.aya_no}"]`);if(n)n.scrollIntoView({behavior:"smooth",block:"center"});else{const e=parseInt(t.page.split("-")[0]);e!==state.currentPage&&(displayPage(e,!0),setTimeout(()=>{activateAyahInDOM(t.sura_no,t.aya_no)&&updateSidebarSelectors()},300))}}function highlightActiveAyah(){state.currentAyah&&activateAyahInDOM(state.currentAyah.sura_no,state.currentAyah.aya_no)}function jumpToFirstAyahOfPage(t,e=!1){const a=getAyahsOnPage(t);if(0===a.length)return;const n=a[0];state.audioPlayer&&(state.audioPlayer.pause(),state.audioPlayer.src=""),state.isPlaying=!1,state.playQueue=[],state.currentPlayIndex=0,state.currentRepeatCount=0,state.currentPlayModeRepeatCount=0,state.currentAyah=n,state.currentSura=n.sura_no,state.currentJuz=n.jozz,getEl("surah-select").value=n.sura_no,getEl("juz-select").value=n.jozz,getEl("page-select").value=t,populateAyahSelector(n.sura_no),getEl("ayah-select").value=n.aya_no,saveSetting("currentAyah",n.aya_no),saveSetting("currentSura",n.sura_no),saveSetting("currentJuz",n.jozz),updatePageInfo(n),setTimeout(()=>{activateAyahInDOM(n.sura_no,n.aya_no),updateNavButtonStates(),e&&getEl("reciter-select").value&&playAudio()},100)}function stopAudio(){state.audioPlayer&&(state.audioPlayer.pause(),state.audioPlayer.currentTime=0,state.audioPlayer.src=""),state.isPlaying=!1,state.currentPlayIndex=0,state.currentRepeatCount=0,state.currentPlayModeRepeatCount=0,state.playQueue=[],updatePauseButton(),syncBottomPlayIcon()}function togglePauseResume(){if(!state.audioPlayer)return;state.audioPlayer.src&&""!==state.audioPlayer.src&&state.audioPlayer.src!==window.location.href?state.audioPlayer.paused?state.audioPlayer.play().catch(()=>{state.currentAyah&&playAudio()}):state.audioPlayer.pause():state.currentAyah&&playAudio()}function updatePauseButton(){const t=getEl("pause-btn"),e=(state.audioPlayer?.paused??!0)||!state.isPlaying?'<i class="bi bi-play-fill"></i> استئناف':'<i class="bi bi-pause-fill"></i> إيقاف مؤقت';t&&(t.innerHTML=e)}async function changeReciterDuringPlayback(t){if(state.isPlaying&&state.currentAyah&&state.audioPlayer&&!state.audioPlayer.paused){const e=state.playQueue[state.currentPlayIndex],a=await checkLocalAudioAvailable(t,e.sura_no);state.useLocalAudio=a;const n=a?buildAudioPath(t,e.sura_no,e.aya_no):getFallbackAudioUrl(t,e.sura_no,e.aya_no)||buildAudioPath(t,e.sura_no,e.aya_no);state.audioPlayer.src=n,state.audioPlayer.playbackRate=parseFloat(getEl("speed-control")?.value||"1"),state.audioPlayer.play().catch(t=>{console.error("Error playing audio with new reciter:",t)})}}function changeSpeed(t){const e=getEl("speed-control"),a=Array.from(e.options).map(t=>parseFloat(t.value)),n=a.indexOf(parseFloat(e.value)),r=Math.max(0,Math.min(a.length-1,n+t));if(r===n)return;const s=a[r];e.value=String(s),state.audioPlayer&&(state.audioPlayer.playbackRate=s),saveSetting("speed",String(s)),e.style.transition="background-color 0.2s",e.style.backgroundColor="#c8a96e44",setTimeout(()=>e.style.backgroundColor="",400),syncBottomSpeedLabel()}function navigateToAyah(t){const e=parseInt(t.page.split("-")[0]),a=state.isPlaying;a&&stopAudio(),e!==state.currentPage?(displayPage(e,!0),setTimeout(()=>{setCurrentAyah(t,{play:a}),populateAyahSelector(t.sura_no),getEl("surah-select").value=t.sura_no,getEl("ayah-select").value=t.aya_no},150)):(t.sura_no!==state.currentSura&&(populateAyahSelector(t.sura_no),getEl("surah-select").value=t.sura_no),setCurrentAyah(t,{play:a}),getEl("ayah-select").value=t.aya_no)}function initializeEventListeners(){getEl("surah-select").addEventListener("change",t=>{const e=parseInt(t.target.value);state.currentSura=e;const a=state.quranData.find(t=>t.sura_no===e&&1===t.aya_no);if(!a)return;displayPage(parseInt(a.page.split("-")[0]),!0),getEl("surah-select").value=e,populateAyahSelector(e),state.currentAyah=a,saveSetting("currentSura",e),saveSetting("currentAyah",a.aya_no);const n=state.isPlaying;n&&stopAudio(),setTimeout(()=>{activateAyahInDOM(e,1),getEl("ayah-select").value=1,updatePageInfo(a),n&&getEl("reciter-select").value&&playAudio()},100)}),getEl("juz-select").addEventListener("change",t=>{const e=parseInt(t.target.value);state.currentJuz=e,saveSetting("currentJuz",e);const a=state.quranData.find(t=>t.jozz===e);if(a){const t=parseInt(a.page.split("-")[0]),e=state.isPlaying;displayPage(t),jumpToFirstAyahOfPage(t,e)}}),getEl("page-select").addEventListener("change",t=>{const e=parseInt(t.target.value),a=state.isPlaying;displayPage(e),jumpToFirstAyahOfPage(e,a)}),getEl("ayah-select").addEventListener("change",t=>{const e=parseInt(t.target.value);if(!e)return;const a=state.quranData.find(t=>t.sura_no===state.currentSura&&t.aya_no===e);if(!a)return;const n=state.isPlaying,r=parseInt(a.page.split("-")[0]);r!==state.currentPage?(displayPage(r,!0),setTimeout(()=>{n?selectAndPlayAyah(a):setCurrentAyah(a)},200)):n?selectAndPlayAyah(a):setCurrentAyah(a)}),getEl("reciter-select").addEventListener("change",t=>{const e=t.target.value;state.selectedReciter=e,saveSetting("reciter",e),changeReciterDuringPlayback(e)}),getEl("speed-control").addEventListener("change",t=>{const e=t.target.value;state.audioPlayer&&(state.audioPlayer.playbackRate=parseFloat(e)),saveSetting("speed",e)}),getEl("repeat-control").addEventListener("change",t=>{saveSetting("repeat",t.target.value)}),getEl("play-mode").addEventListener("change",t=>{saveSetting("playMode",t.target.value)}),getEl("font-size-control").addEventListener("change",t=>{applyFontSize(t.target.value),saveSetting("fontSize",t.target.value)}),getEl("prev-page").addEventListener("click",()=>{if(state.currentPage>1){const t=state.currentPage-1,e=state.isPlaying;displayPage(t),jumpToFirstAyahOfPage(t,e)}}),getEl("next-page").addEventListener("click",()=>{if(state.currentPage<604){const t=state.currentPage+1,e=state.isPlaying;displayPage(t),jumpToFirstAyahOfPage(t,e)}}),getEl("play-btn").addEventListener("click",playAudio),getEl("pause-btn").addEventListener("click",togglePauseResume),getEl("stop-btn").addEventListener("click",stopAudio),document.addEventListener("keydown",t=>{if(["INPUT","TEXTAREA","SELECT"].includes(t.target.tagName))return;if("Space"===t.code){t.preventDefault();return void(state.audioPlayer?.src&&""!==state.audioPlayer.src?togglePauseResume():state.currentAyah&&playAudio())}const e=t.code.match(/^(?:Digit|Numpad)([0-9])$/);if(e&&state.audioPlayer?.src&&""!==state.audioPlayer.src&&state.audioPlayer.duration){t.preventDefault();const a=parseInt(e[1])/10;return void(state.audioPlayer.currentTime=state.audioPlayer.duration*a)}if("ArrowLeft"!==t.code){if("ArrowRight"!==t.code)return"Equal"===t.code||"NumpadAdd"===t.code?(t.preventDefault(),void changeSpeed(1)):"Minus"===t.code||"NumpadSubtract"===t.code?(t.preventDefault(),void changeSpeed(-1)):void 0;if(t.preventDefault(),state.currentAyah){const t=state.quranData.find(t=>t.sura_no===state.currentAyah.sura_no&&t.aya_no===state.currentAyah.aya_no-1);if(t)navigateToAyah(t);else if(state.currentAyah.sura_no>1){const t=state.quranData.filter(t=>t.sura_no===state.currentAyah.sura_no-1);t.length>0&&navigateToAyah(t[t.length-1])}}}else if(t.preventDefault(),state.currentAyah){const t=state.quranData.find(t=>t.sura_no===state.currentAyah.sura_no&&t.aya_no===state.currentAyah.aya_no+1);if(t)navigateToAyah(t);else{const t=state.quranData.find(t=>t.sura_no===state.currentAyah.sura_no+1&&1===t.aya_no);t&&navigateToAyah(t)}}})}function syncBottomSpeedLabel(){const t=getEl("speed-control"),e=getEl("bottom-speed-label");t&&e&&(e.textContent=parseFloat(t.value)+"x")}function syncBottomPlayIcon(){const t=getEl("bottom-play-icon");t&&(t.className=state.isPlaying?"bi bi-pause-fill":"bi bi-play-fill")}function updateNavButtonStates(){document.querySelectorAll(".bottom-controls .ctrl-btn");const t=document.querySelector('.ctrl-btn[onclick="bottomNavPrevSurah()"]'),e=document.querySelector('.ctrl-btn[onclick="bottomNavPrev()"]'),a=document.querySelector('.ctrl-btn[onclick="bottomNavNext()"]'),n=document.querySelector('.ctrl-btn[onclick="bottomNavNextSurah()"]');if(!state.currentAyah)return t&&(t.disabled=!0),e&&(e.disabled=!0),a&&(a.disabled=!0),void(n&&(n.disabled=!0));const r=state.currentAyah.sura_no,s=state.currentAyah.aya_no,o=!!state.quranData.find(t=>t.sura_no===r&&t.aya_no===s-1),u=r>1,l=!!state.quranData.find(t=>t.sura_no===r&&t.aya_no===s+1)||r<114,c=r<114;e&&(e.disabled=!o&&!u),t&&(t.disabled=!u),a&&(a.disabled=!l),n&&(n.disabled=!c)}function bottomPlayPause(){state.audioPlayer?.src&&""!==state.audioPlayer.src?togglePauseResume():state.currentAyah&&playAudio(),setTimeout(syncBottomPlayIcon,100)}function bottomNavNext(){if(!state.currentAyah)return;const t=state.quranData.find(t=>t.sura_no===state.currentAyah.sura_no&&t.aya_no===state.currentAyah.aya_no+1);if(t)return void navigateToAyah(t);const e=state.quranData.find(t=>t.sura_no===state.currentAyah.sura_no+1&&1===t.aya_no);e&&navigateToAyah(e)}function bottomNavPrev(){if(!state.currentAyah)return;const t=state.quranData.find(t=>t.sura_no===state.currentAyah.sura_no&&t.aya_no===state.currentAyah.aya_no-1);if(t)navigateToAyah(t);else if(state.currentAyah.sura_no>1){const t=state.quranData.filter(t=>t.sura_no===state.currentAyah.sura_no-1);t.length&&navigateToAyah(t[t.length-1])}}function bottomNavPrevSurah(){if(!state.currentAyah||state.currentAyah.sura_no<=1)return;const t=state.quranData.find(t=>t.sura_no===state.currentAyah.sura_no-1&&1===t.aya_no);t&&navigateToAyah(t)}function bottomNavNextSurah(){if(!state.currentAyah||state.currentAyah.sura_no>=114)return;const t=state.quranData.find(t=>t.sura_no===state.currentAyah.sura_no+1&&1===t.aya_no);t&&navigateToAyah(t)}function initializeBottomControls(){syncBottomSpeedLabel();const t=getEl("audio-player");t&&(t.addEventListener("play",()=>setTimeout(syncBottomPlayIcon,50)),t.addEventListener("pause",()=>setTimeout(syncBottomPlayIcon,50)),t.addEventListener("ended",()=>setTimeout(syncBottomPlayIcon,50)));const e=getEl("speed-control");e&&e.addEventListener("change",syncBottomSpeedLabel)}document.addEventListener("DOMContentLoaded",async()=>{await loadQuranData(),await loadAudioUrlsData(),initializeSelectors(),initializeAudioPlayer(),loadSettings(),initializeEventListeners(),initializeBottomControls();const t=parseInt(localStorage.getItem("currentPage"))||1,e=parseInt(localStorage.getItem("currentSura"))||1,a=parseInt(localStorage.getItem("currentAyah"))||null;displayPage(t,!0),e&&a?setTimeout(()=>restoreSavedAyah(e,a),200):setTimeout(()=>{const t=state.quranData.find(t=>t.sura_no===e&&1===t.aya_no);t&&(state.currentAyah=t,state.currentSura=t.sura_no,populateAyahSelector(t.sura_no),getEl("ayah-select").value=1,updatePageInfo(t),activateAyahInDOM(t.sura_no,1),updateNavButtonStates())},200)});