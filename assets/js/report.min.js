!function(){"use strict";let e=[],t=!1;function n(t,n){return e.filter(e=>{const r=String(e.page).split("-").map(e=>parseInt(e.trim()));return e.sura_no===t&&r.includes(n)}).map(e=>e.aya_no).sort((e,t)=>e-t)}function r(t){const n=e.find(e=>e.sura_no===t);return n?parseInt(String(n.page).split("-")[0]):null}function a(e,t){const r=n(e,t);return r.length>0?r[0]:1}function s(t){const n=document.getElementById("r-page");if(!n)return;const r=n.value;n.innerHTML='<option value="" disabled>اختر الصفحة...</option>';const a=t?function(t){const n=new Set;return e.filter(e=>e.sura_no===t).forEach(e=>String(e.page).split("-").forEach(e=>n.add(parseInt(e.trim())))),[...n].sort((e,t)=>e-t)}(t):Array.from({length:604},(e,t)=>t+1);a.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=`صفحة ${e}`,n.appendChild(t)}),r&&[...n.options].some(e=>e.value===String(r))&&(n.value=r)}function o(t,r){const a=document.getElementById("r-aya");if(!a)return;if(a.innerHTML='<option value="" disabled>اختر الآية...</option>',!t||!r)return;const s=n(t,r);0===s.length?e.filter(e=>e.sura_no===t).map(e=>e.aya_no).forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=`آية ${e}`,a.appendChild(t)}):s.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=`آية ${e}`,a.appendChild(t)})}!function n(){"undefined"!=typeof state&&state.quranData&&state.quranData.length>0?(e=state.quranData,t=!0,function(){const t=document.getElementById("r-sura-ar");if(!t)return;const n=t.value;t.innerHTML='<option value="" disabled>اختر السورة...</option>',function(){const t=new Set;return e.filter(e=>!t.has(e.sura_no)&&(t.add(e.sura_no),!0)).map(e=>({no:e.sura_no,name:e.sura_name_ar}))}().forEach(e=>{const n=document.createElement("option");n.value=e.no,n.textContent=`${e.no}. ${e.name}`,t.appendChild(n)}),n&&(t.value=n)}(),s()):setTimeout(n,300)}(),document.getElementById("r-sura-ar").addEventListener("change",function(){const e=parseInt(this.value);c("r-sura-ar");const t=r(e);s(e),t&&(document.getElementById("r-page").value=t),c("r-page");const n=parseInt(document.getElementById("r-page").value);o(e,n);const l=a(e,n);l&&(document.getElementById("r-aya").value=l),c("r-aya")}),document.getElementById("r-page").addEventListener("change",function(){const t=parseInt(this.value);c("r-page");const n=parseInt(document.getElementById("r-sura-ar").value),r=e.some(e=>{const r=String(e.page).split("-").map(e=>parseInt(e.trim()));return e.sura_no===n&&r.includes(t)});let s=n;r||(s=function(t){const n=e.find(e=>String(e.page).split("-").map(e=>parseInt(e.trim())).includes(t));return n?n.sura_no:null}(t),s&&(document.getElementById("r-sura-ar").value=s,c("r-sura-ar"))),o(s,t);const l=a(s,t);l&&(document.getElementById("r-aya").value=l),c("r-aya")}),document.getElementById("r-aya").addEventListener("change",function(){c("r-aya")}),window.prefillReportModal=function(){if(t)try{const e="undefined"!=typeof state?state:null,t=e&&e.currentAyah?e.currentAyah:null,n=t?t.sura_no:parseInt(localStorage.getItem("currentSura"))||null,a=t?t.aya_no:parseInt(localStorage.getItem("currentAyah"))||null,l=t?parseInt(String(t.page).split("-")[0]):parseInt(localStorage.getItem("currentPage"))||null;if(!n)return;const u="undefined"!=typeof state&&state.currentRiwaya||localStorage.getItem("riwaya")||null;u&&(document.getElementById("r-riwaya").value=u,c("r-riwaya")),document.getElementById("r-sura-ar").value=n,c("r-sura-ar"),s(n),l&&(document.getElementById("r-page").value=l,c("r-page"));o(n,l||r(n)),a&&(document.getElementById("r-aya").value=a,c("r-aya"))}catch(e){}else setTimeout(window.prefillReportModal,300)};const l={"r-email":"err-email","r-type":"err-type","r-subject":"err-subject","r-riwaya":"err-riwaya","r-sura-ar":"err-sura-ar","r-page":"err-page","r-aya":"err-aya","r-details":"err-details"},u={"r-email":{empty:"البريد الإلكتروني مطلوب.",invalid:"أدخل بريداً إلكترونياً صحيحاً."},"r-type":{empty:"يرجى اختيار نوع الرسالة."},"r-subject":{empty:"عنوان الموضوع مطلوب."},"r-riwaya":{empty:"يرجى اختيار الرواية."},"r-sura-ar":{empty:"يرجى اختيار السورة."},"r-page":{empty:"يرجى اختيار الصفحة."},"r-aya":{empty:"يرجى اختيار الآية."},"r-details":{empty:"تفاصيل الرسالة مطلوبة."}};function i(e,t){const n=document.getElementById(l[e]),r=document.getElementById(e);n&&(n.textContent=t),r&&r.classList.add("report-input--error")}function c(e){const t=document.getElementById(l[e]),n=document.getElementById(e);t&&(t.textContent=""),n&&n.classList.remove("report-input--error")}function d(e){const t=document.getElementById(e),n=u[e];if(!t||!n)return!0;const r=t.value.trim();return r?"r-email"!==e||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)?(c(e),!0):(i(e,n.invalid),!1):(i(e,n.empty),!1)}["r-email","r-subject","r-details"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("blur",()=>d(e)),t.addEventListener("input",()=>{t.classList.contains("report-input--error")&&d(e)}))}),["r-type","r-riwaya"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",()=>d(e))}),document.getElementById("reportModal").addEventListener("hidden.bs.modal",()=>{document.getElementById("reportForm").reset(),Object.keys(l).forEach(e=>c(e));const e=document.getElementById("r-status");e.style.display="none",e.className="report-status",t&&(s(),document.getElementById("r-aya").innerHTML='<option value="" disabled selected>اختر الآية...</option>')});const m=e=>new Promise((t,n)=>{const r=new FileReader;r.readAsDataURL(e),r.onload=()=>{let e=r.result.toString().replace(/^data:(.*,)?/,"");e.length%4>0&&(e+="=".repeat(4-e.length%4)),t(e)},r.onerror=e=>n(e)});document.getElementById("reportForm").addEventListener("submit",async t=>{t.preventDefault();if(!Object.keys(l).map(e=>d(e)).every(Boolean))return;const n=document.getElementById("r-submit-btn"),r=document.getElementById("r-status");n.disabled=!0,n.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>جارٍ المعالجة...',r.style.display="none",r.className="report-status";try{const t=parseInt(document.getElementById("r-sura-ar").value),a=e.find(e=>e.sura_no===t),s=a?a.sura_name_ar:String(t),o={email:document.getElementById("r-email").value.trim(),message_type:document.getElementById("r-type").value,subject_title:document.getElementById("r-subject").value.trim(),message_details:document.getElementById("r-details").value.trim(),riwaya:document.getElementById("r-riwaya").value,sura_name_ar:s,aya_no:document.getElementById("r-aya").value,page:document.getElementById("r-page").value},l=document.getElementById("r-upload"),u=[];if(l.files.length>0){n.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>جارٍ معالجة الملفات...';for(let e=0;e<l.files.length;e++){const t=l.files[e];if(!t.type.startsWith("image/")&&"application/pdf"!==t.type)throw new Error(`"${t.name}" غير مقبول. الملفات المسموح بها: صور وPDF فقط.`);u.push({fileName:t.name,mimeType:t.type,fileData:await m(t)})}}o.files=u,n.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>جارٍ الإرسال...';const i=await fetch("https://script.google.com/macros/s/AKfycbz0a0HARrBElD6zDXmfGLNTxwxLQT4YCw_HQ-mDKocRfwrogIy3cdBH9UQ2eFwlNbdcEA/exec",{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(o)}),c=await i.json();if("success"!==c.status)throw new Error(c.message||"أعاد الخادم خطأً غير متوقع.");{const e=u.length;r.className="report-status report-status--success",r.textContent=e>0?`تم إرسال التقرير بنجاح مع ${e} مرفق! شكراً لك.`:"تم إرسال التقرير بنجاح! شكراً لك على مساهمتك.",r.style.display="block"}}catch(e){console.error(e),r.className="report-status report-status--error",r.textContent=e.message||"فشل إرسال التقرير. يرجى المحاولة مرة أخرى.",r.style.display="block"}finally{n.disabled=!1,n.innerHTML='<i class="bi bi-send-fill me-2"></i>إرسال التقرير'}})}();